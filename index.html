<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ProComm | Commission Calculator</title>
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet" />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet" />
    <style>
      :root {
        --primary: #3b82f6;
        --primary-dark: #2563eb;
        --primary-darker: #1e3a8a;
        --secondary: #00b4d8;
        --secondary-dark: #0096c7;
        --accent: #ff7d00;
        --background: #0f172a;
        --background-light: #1e293b;
        --background-lighter: #334155;
        --paper: #1e293b;
        --paper-light: #334155;
        --text-primary: #f8fafc;
        --text-secondary: #94a3b8;
        --divider: #334155;
        --success: #10b981;
        --error: #ef4444;
        --border-radius: 10px;
        --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2),
          0 2px 4px -1px rgba(0, 0, 0, 0.1);
        --box-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.3),
          0 4px 6px -2px rgba(0, 0, 0, 0.2);
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: 'Poppins', sans-serif;
        background-color: var(--background);
        color: var(--text-primary);
        margin: 0;
        padding: 0;
        line-height: 1.6;
      }

      .gradient-bg {
        background: linear-gradient(
          135deg,
          var(--primary-darker) 0%,
          var(--primary-dark) 50%,
          var(--primary) 100%
        );
      }

      .shadow-3d {
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3),
          0 10px 10px -5px rgba(0, 0, 0, 0.1);
      }

      .pulse-animation {
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      .slide-in {
        animation: slideIn 0.5s ease-out;
      }

      @keyframes slideIn {
        from {
          transform: translateY(20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .app-bar {
        background: linear-gradient(
          135deg,
          var(--primary-darker),
          var(--primary-dark)
        );
        color: white;
        padding: 1rem 2rem;
        box-shadow: var(--box-shadow);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 1000;
      }

      .app-bar-content {
        display: flex;
        flex-direction: column;
      }

      .app-bar h1 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
      }

      .app-bar p {
        margin: 0.25rem 0 0;
        font-size: 0.875rem;
        opacity: 0.9;
      }

      .card {
        background-color: var(--paper);
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        transition: var(--transition);
        border: 1px solid var(--divider);
      }

      .card:hover {
        box-shadow: var(--box-shadow-hover);
        transform: translateY(-2px);
      }

      .card-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1.25rem;
        color: var(--primary);
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .card-title .material-icons {
        font-size: 1.5rem;
      }

      .text-field {
        margin-bottom: 1rem;
      }

      .text-field label {
        display: block;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-primary);
      }

      .text-field input,
      .text-field select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--divider);
        border-radius: var(--border-radius);
        font-size: 1rem;
        transition: var(--transition);
        background-color: var(--paper-light);
        color: var(--text-primary);
      }

      .text-field input:focus,
      .text-field select:focus {
        outline: none;
        border-color: var(--secondary);
        box-shadow: 0 0 0 2px rgba(0, 180, 216, 0.3);
      }

      .button {
        background-color: var(--primary);
        color: white;
        border: none;
        border-radius: var(--border-radius);
        padding: 0.75rem 1.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        cursor: pointer;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        letter-spacing: 0.5px;
      }

      .button:hover {
        background-color: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: var(--box-shadow-hover);
      }

      .button:active {
        transform: translateY(0);
      }

      .button.secondary {
        background-color: var(--secondary);
      }

      .button.secondary:hover {
        background-color: var(--secondary-dark);
      }

      .button.accent {
        background-color: var(--accent);
      }

      .checkbox {
        display: flex;
        align-items: center;
        margin-bottom: 0.75rem;
        cursor: pointer;
      }

      .checkbox input {
        width: 1.25rem;
        height: 1.25rem;
        margin-right: 0.75rem;
        accent-color: var(--secondary);
        cursor: pointer;
      }

      .checkbox label {
        font-size: 0.9375rem;
        color: var(--text-primary);
        cursor: pointer;
      }

      .result-value {
        font-size: 1.75rem;
        font-weight: 600;
        color: var(--primary);
      }

      .result-row {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--divider);
        align-items: center;
      }

      .result-row:last-child {
        border-bottom: none;
      }

      .result-row strong {
        font-weight: 500;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1.5rem;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 1.5rem;
      }

      .col-8 {
        grid-column: span 8;
      }

      .col-4 {
        grid-column: span 4;
      }

      .property-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: var(--border-radius);
        margin-bottom: 1rem;
      }

      .property-address {
        margin-bottom: 1rem;
      }

      .property-address input {
        margin-bottom: 0.5rem;
      }

      .input-group {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .input-group .text-field {
        flex: 1;
        margin-bottom: 0;
      }

      .highlight-box {
        background: linear-gradient(
          135deg,
          var(--primary-darker),
          var(--primary-dark)
        );
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border-left: 4px solid var(--secondary);
      }

      .tip-card {
        display: flex;
        align-items: flex-start;
        margin-bottom: 1rem;
        background-color: rgba(0, 180, 216, 0.1);
        padding: 1rem;
        border-radius: var(--border-radius);
        border-left: 3px solid var(--secondary);
      }

      .tip-card .material-icons {
        color: var(--secondary);
        margin-right: 0.75rem;
        font-size: 1.25rem;
        margin-top: 0.125rem;
      }

      .tip-card p {
        margin: 0;
        font-size: 0.875rem;
        flex: 1;
      }

      .conversion-tool {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 0.5rem;
      }

      .conversion-tool input {
        flex: 1;
      }

      .conversion-result {
        text-align: right;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--primary);
      }

      .no-print {
        display: block;
      }

      @media print {
        body * {
          visibility: hidden;
        }
        #printable-results,
        #printable-results * {
          visibility: visible;
        }
        #printable-results {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
          padding: 1rem;
          background-color: white !important;
          color: black !important;
        }
        .no-print {
          display: none !important;
        }
        .highlight-box {
          background: white !important;
          border: 1px solid #ddd !important;
        }
      }

      /* Responsive adjustments */
      @media (max-width: 1024px) {
        .grid {
          grid-template-columns: 1fr;
        }
        .col-8,
        .col-4 {
          grid-column: span 1;
        }
        .container {
          padding: 1rem;
        }
      }

      @media (max-width: 768px) {
        .app-bar {
          flex-direction: column;
          align-items: flex-start;
          padding: 1rem;
        }
        .app-bar-actions {
          margin-top: 1rem;
          width: 100%;
        }
        .button {
          width: 100%;
          margin-bottom: 0.5rem;
        }
        .input-group {
          flex-direction: column;
          gap: 0;
        }
      }

      @media (max-width: 480px) {
        .card {
          padding: 1rem;
        }
        .result-value {
          font-size: 1.5rem;
        }
        .button {
          padding: 0.75rem;
        }
      }

      /* Animation */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .fade-in {
        animation: fadeIn 0.5s ease-out forwards;
      }

      /* Tooltip */
      .tooltip {
        position: relative;
        display: inline-block;
      }

      .tooltip .tooltip-text {
        visibility: hidden;
        width: 200px;
        background-color: var(--primary-dark);
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 0.5rem;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.75rem;
        font-weight: normal;
      }

      .tooltip:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
      }

      /* Loading spinner */
      .spinner {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
        margin-left: 0.5rem;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Toast notification */
      .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: var(--primary-dark);
        color: white;
        padding: 12px 24px;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow-hover);
        z-index: 1000;
        transform: translateY(20px);
        opacity: 0;
        transition: all 0.3s ease;
      }

      /* Glow effect */
      .glow {
        box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
      }

      /* Bounce animation */
      @keyframes bounce {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-5px);
        }
      }

      .bounce {
        animation: bounce 1s infinite;
      }
    </style>
  </head>
  <body>
    <div class="app-bar gradient-bg shadow-3d">
      <div class="app-bar-content">
        <div class="flex justify-between">
          <img
            width="120px"
            height="auto"
            src="assets/images/logo/logo-nobg.png"
            alt="logo" />
        </div>
        <p>Real Estate Agent Commission Calculator</p>
      </div>
      <div class="app-bar-actions no-print">
        <div style="display: flex; gap: 0.75rem">
          <!-- <button id="saveDealBtn" class="button disabled">
            <span class="material-icons">save</span> Save Deal
          </button> -->
          <button id="printBtn" class="button secondary" style="color: #0f172a">
            <span class="material-icons">print</span> Print
          </button>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="grid">
        <div class="col-8">
          <div class="card shadow-3d">
            <div class="card-title">
              <span class="material-icons">home</span> Financial Details
            </div>

            <div class="property-address">
              <!-- <div class="text-field">
                <label>Property Address</label>
                <input
                  type="text"
                  id="propertyAddress"
                  placeholder="27 Albus Drive, Sunset Beach" />
              </div> -->
              <!-- <div class="text-field">
                <label>Property Image URL</label>
                <input
                  type="text"
                  id="propertyImageUrl"
                  placeholder="https://example.com/property.jpg" />
              </div> -->
            </div>

            <div class="input-group">
              <div class="text-field">
                <label>Property Value (ZAR)</label>
                <input
                  type="number"
                  id="propertyValue"
                  inputmode="numeric"
                  placeholder="e.g. 2500000" />
              </div>
              <div class="text-field">
                <label>Commission Rate (%)</label>
                <input
                  type="number"
                  id="commissionRate"
                  inputmode="numeric"
                  placeholder="e.g. 5.5"
                  step="0.1" />
              </div>
            </div>

            <div class="input-group">
              <div class="text-field">
                <label>VAT Included?</label>
                <select id="vatIncluded">
                  <option value="excluded">No, add VAT</option>
                  <option value="included">Yes, VAT included</option>
                </select>
              </div>
              <div class="text-field">
                <label>Deal Type</label>
                <select id="dealType">
                  <option value="sale">Sale</option>
                  <option value="rental">Rental</option>
                </select>
              </div>
            </div>
          </div>

          <div class="card shadow-3d">
            <div class="card-title">
              <span class="material-icons">groups</span> Agent Fee Structure
            </div>

            <div class="input-group">
              <div class="text-field">
                <label>Agent Split (%)</label>
                <input
                  type="number"
                  inputmode="numeric"
                  id="agentSplit"
                  value="70"
                  step="1" />
                <p
                  style="
                    margin-top: 0.25rem;
                    font-size: 0.75rem;
                    color: var(--text-secondary);
                  ">
                  Your percentage of the commission
                </p>
              </div>
              <div class="text-field">
                <label>Office Fees (ZAR)</label>
                <input
                  type="number"
                  inputmode="numeric"
                  id="officeFees"
                  value="0" />
                <p
                  style="
                    margin-top: 0.25rem;
                    font-size: 0.75rem;
                    color: var(--text-secondary);
                  ">
                  Fixed office/admin fees (optional)
                </p>
              </div>
            </div>

            <div class="input-group">
              <div class="text-field">
                <label>Co-Agent Split (%)</label>
                <input
                  type="number"
                  inputmode="numeric"
                  id="coAgentSplit"
                  value="0"
                  step="1" />
                <p
                  style="
                    margin-top: 0.25rem;
                    font-size: 0.75rem;
                    color: var(--text-secondary);
                  ">
                  If working with another agent
                </p>
              </div>
              <div class="text-field">
                <label>Referral Fee (%)</label>
                <input
                  type="number"
                  inputmode="numeric"
                  id="referralFee"
                  value="0"
                  step="1" />
                <p
                  style="
                    margin-top: 0.25rem;
                    font-size: 0.75rem;
                    color: var(--text-secondary);
                  ">
                  If deal came from a referral
                </p>
              </div>
            </div>
          </div>

          <div class="card shadow-3d">
            <div class="card-title">
              <span class="material-icons">settings</span> Additional Fees
            </div>

            <div class="checkbox">
              <input type="checkbox" id="ppaProtection" />
              <label for="ppaProtection">PPA Protection Fee (R1,995)</label>
            </div>

            <div class="checkbox">
              <input type="checkbox" id="marketingContribution" />
              <label for="marketingContribution"
                >Marketing Contribution (1%)</label
              >
            </div>

            <div class="checkbox">
              <input type="checkbox" id="teamLeaderCut" />
              <label for="teamLeaderCut">Team Leader Cut (10%)</label>
            </div>
          </div>

          <div style="text-align: center; margin-top: 1.5rem">
            <button
              id="calculateBtn"
              class="button secondary shadow-3d"
              style="padding: 1rem 2rem; font-size: 1rem; color: #0f172a">
              <span class="material-icons">calculate</span> CALCULATE COMMISSION
            </button>
          </div>

          <div
            id="recentCalculations"
            class="card shadow-3d"
            style="display: none">
            <div class="card-title">
              <span class="material-icons">history</span> Recent Calculations
            </div>
            <div style="overflow-x: auto">
              <table style="width: 100%; border-collapse: collapse">
                <thead>
                  <tr style="border-bottom: 1px solid var(--divider)">
                    <th
                      style="
                        text-align: left;
                        padding: 0.75rem;
                        font-size: 0.875rem;
                        color: var(--text-secondary);
                      ">
                      Property Value
                    </th>
                    <th
                      style="
                        text-align: left;
                        padding: 0.75rem;
                        font-size: 0.875rem;
                        color: var(--text-secondary);
                      ">
                      Your Commission
                    </th>
                    <th
                      style="
                        text-align: left;
                        padding: 0.75rem;
                        font-size: 0.875rem;
                        color: var(--text-secondary);
                      ">
                      Date
                    </th>
                    <th
                      style="
                        text-align: left;
                        padding: 0.75rem;
                        font-size: 0.875rem;
                        color: var(--text-secondary);
                      ">
                      Actions
                    </th>
                  </tr>
                </thead>
                <tbody id="recentCalculationsBody">
                  <!-- Will be populated by JS -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="col-4">
          <div id="resultsPanel" class="card shadow-3d" style="display: none">
            <div id="printable-results">
              <div class="card-title no-print">
                <span class="material-icons">pie_chart</span> Commission
                Breakdown
              </div>

              <div id="propertyImageContainer" style="display: none">
                <img
                  id="propertyImage"
                  class="property-image"
                  src=""
                  alt="Property Image" />
              </div>

              <div
                id="propertyAddressDisplay"
                style="
                  margin-bottom: 1rem;
                  font-weight: 500;
                  display: none;
                "></div>

              <div style="margin-bottom: 1.5rem">
                <h3
                  style="
                    font-size: 1rem;
                    font-weight: 600;
                    margin-bottom: 0.75rem;
                    color: var(--primary);
                  ">
                  Summary
                </h3>

                <div class="result-row">
                  <span>Property Value:</span>
                  <span id="resultPropertyValue">R0.00</span>
                </div>

                <div class="result-row">
                  <span>Commission Rate:</span>
                  <span id="resultCommissionRate">0%</span>
                </div>

                <div
                  class="result-row"
                  style="
                    border-top: 2px solid var(--divider);
                    padding-top: 0.75rem;
                  ">
                  <span style="font-weight: 500">Gross Commission:</span>
                  <span id="resultGrossCommission" style="font-weight: 500"
                    >R0.00</span
                  >
                </div>
              </div>

              <div style="margin-bottom: 1.5rem">
                <h3
                  style="
                    font-size: 1rem;
                    font-weight: 600;
                    margin-bottom: 0.75rem;
                    color: var(--primary);
                  ">
                  Deductions
                </h3>

                <div class="result-row">
                  <span>VAT (15%):</span>
                  <span id="resultVat">R0.00</span>
                </div>

                <div class="result-row">
                  <span>Office Split:</span>
                  <span id="resultOfficeSplit">R0.00</span>
                </div>

                <div class="result-row">
                  <span>Office Fees:</span>
                  <span id="resultOfficeFees">R0.00</span>
                </div>

                <div class="result-row">
                  <span>Co-Agent Share:</span>
                  <span id="resultCoAgent">R0.00</span>
                </div>

                <div class="result-row">
                  <span>Referral Fee:</span>
                  <span id="resultReferralFee">R0.00</span>
                </div>

                <div
                  id="resultPpaContainer"
                  class="result-row"
                  style="display: none">
                  <span>PPA Protection:</span>
                  <span id="resultPpa">R0.00</span>
                </div>

                <div
                  id="resultMarketingContainer"
                  class="result-row"
                  style="display: none">
                  <span>Marketing Contribution:</span>
                  <span id="resultMarketing">R0.00</span>
                </div>

                <div
                  id="resultTeamLeaderContainer"
                  class="result-row"
                  style="display: none">
                  <span>Team Leader Cut:</span>
                  <span id="resultTeamLeader">R0.00</span>
                </div>
              </div>

              <div class="highlight-box slide-in">
                <h3
                  style="
                    font-size: 1rem;
                    font-weight: 600;
                    margin-bottom: 0.75rem;
                    color: white;
                  ">
                  Your Net Commission
                </h3>

                <div style="text-align: center; padding: 0.5rem 0">
                  <span
                    id="resultNetCommission"
                    class="result-value"
                    style="color: white"
                    >R0.00</span
                  >
                </div>

                <div
                  style="
                    text-align: center;
                    font-size: 0.875rem;
                    color: rgba(255, 255, 255, 0.8);
                  ">
                  <span id="resultPercentageOfTotal" style="font-weight: 500"
                    >0%</span
                  >
                  of gross commission
                </div>
              </div>
            </div>

            <!-- <div
              style="text-align: center; margin-top: 1.5rem"
              class="no-print">
              <button id="saveResultBtn" class="button shadow-3d">
                <span class="material-icons">save</span> Save This Calculation
              </button>
            </div> -->
          </div>

          <div class="card shadow-3d no-print">
            <div class="card-title">
              <span class="material-icons">lightbulb</span> Negotiation Tips
            </div>

            <div class="tip-card slide-in">
              <span class="material-icons">emoji_objects</span>
              <p>
                For properties over R3M, consider reducing your commission %
                slightly to close the deal while maintaining high Rand value.
              </p>
            </div>

            <div class="tip-card slide-in">
              <span class="material-icons">percent</span>
              <p>
                Standard commission in SA is 5-7.5% + VAT for sales, and 10-12%
                of annual rent for rentals.
              </p>
            </div>

            <div class="tip-card slide-in">
              <span class="material-icons">handshake</span>
              <p>
                When co-broking, agree on splits upfront to avoid disputes
                later.
              </p>
            </div>
          </div>

          <div class="card shadow-3d no-print">
            <div class="card-title">
              <span class="material-icons">swap_horiz</span> Conversion Tools
            </div>

            <div style="margin-bottom: 1rem">
              <div class="text-field">
                <label>USD to ZAR</label>
                <div class="conversion-tool">
                  <input
                    type="number"
                    id="usdAmount"
                    placeholder="USD Amount"
                    style="flex: 1" />
                  <button
                    id="convertUsdBtn"
                    class="button shadow-3d"
                    style="width: 100px">
                    Convert
                  </button>
                </div>
                <div class="conversion-result">
                  <span id="zarResult">ZAR: R0.00</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        // Elements
        const calculateBtn = document.getElementById('calculateBtn');
        const resultsPanel = document.getElementById('resultsPanel');
        const saveResultBtn = document.getElementById('saveResultBtn');
        const printBtn = document.getElementById('printBtn');
        const saveDealBtn = document.getElementById('saveDealBtn');
        const recentCalculations =
          document.getElementById('recentCalculations');
        const recentCalculationsBody = document.getElementById(
          'recentCalculationsBody'
        );
        const convertUsdBtn = document.getElementById('convertUsdBtn');
        const calculateHourlyBtn =
          document.getElementById('calculateHourlyBtn');
        const propertyImageUrl = document.getElementById('propertyImageUrl');
        const propertyImageContainer = document.getElementById(
          'propertyImageContainer'
        );
        const propertyImage = document.getElementById('propertyImage');
        const propertyAddress = document.getElementById('propertyAddress');
        const propertyAddressDisplay = document.getElementById(
          'propertyAddressDisplay'
        );

        // Load saved calculations from localStorage
        let savedCalculations =
          JSON.parse(localStorage.getItem('savedCalculations')) || [];
        updateRecentCalculations();

        // Load property data from localStorage
        const savedPropertyData =
          JSON.parse(localStorage.getItem('propertyData')) || {};
        if (savedPropertyData.address)
          propertyAddress.value = savedPropertyData.address;
        if (savedPropertyData.imageUrl)
          propertyImageUrl.value = savedPropertyData.imageUrl;
        if (savedPropertyData.value)
          document.getElementById('propertyValue').value =
            savedPropertyData.value;

        // Calculate Commission
        calculateBtn.addEventListener('click', function () {
          calculateCommission();
        });

        // Save Calculation
        saveResultBtn.addEventListener('click', function () {
          saveCalculation();
        });

        // Print (only commission breakdown)
        printBtn.addEventListener('click', function () {
          window.print();
        });

        // Save Deal
        saveDealBtn.addEventListener('click', function () {
          savePropertyData();
          showToast('Property details saved successfully!');
        });

        // USD to ZAR Conversion
        convertUsdBtn.addEventListener('click', function () {
          const usdAmount =
            parseFloat(document.getElementById('usdAmount').value) || 0;
          // Using approximate exchange rate - in a real app you'd fetch this from an API
          const zarAmount = usdAmount * 18.5;
          document.getElementById(
            'zarResult'
          ).textContent = `ZAR: R${formatCurrency(zarAmount)}`;
        });

        // Hourly Rate Calculation
        calculateHourlyBtn.addEventListener('click', function () {
          const hoursWorked =
            parseFloat(document.getElementById('hoursWorked').value) || 1;
          const netCommission =
            parseFloat(
              document
                .getElementById('resultNetCommission')
                .textContent.replace('R', '')
                .replace(/,/g, '')
            ) || 0;
          const hourlyRate = netCommission / hoursWorked;
          document.getElementById(
            'hourlyRateResult'
          ).textContent = `Hourly Rate: R${formatCurrency(hourlyRate)}/hr`;
        });

        // Property image URL change
        if (propertyImageUrl) {
          propertyImageUrl.addEventListener('change', function () {
            if (propertyImageUrl.value) {
              propertyImage.src = propertyImageUrl.value;
              propertyImageContainer.style.display = 'block';
            } else {
              propertyImageContainer.style.display = 'none';
            }
          });
        }

        // Save property data to localStorage
        function savePropertyData() {
          const propertyData = {
            address: propertyAddress ? propertyAddress.value : '',
            imageUrl: propertyImageUrl ? propertyImageUrl.value : '',
            value: document.getElementById('propertyValue').value,
          };
          localStorage.setItem('propertyData', JSON.stringify(propertyData));
        }

        // Commission Calculation Function
        function calculateCommission() {
          // Show loading state
          calculateBtn.innerHTML =
            '<span class="spinner"></span> Calculating...';
          calculateBtn.disabled = true;

          // Simulate calculation delay for better UX
          setTimeout(() => {
            // Get input values
            const propertyValue =
              parseFloat(document.getElementById('propertyValue').value) || 0;
            const commissionRate =
              parseFloat(document.getElementById('commissionRate').value) || 0;
            const vatIncluded = document.getElementById('vatIncluded').value;
            const agentSplit =
              parseFloat(document.getElementById('agentSplit').value) || 0;
            const officeFees =
              parseFloat(document.getElementById('officeFees').value) || 0;
            const coAgentSplit =
              parseFloat(document.getElementById('coAgentSplit').value) || 0;
            const referralFee =
              parseFloat(document.getElementById('referralFee').value) || 0;
            const ppaProtection =
              document.getElementById('ppaProtection').checked;
            const marketingContribution = document.getElementById(
              'marketingContribution'
            ).checked;
            const teamLeaderCut =
              document.getElementById('teamLeaderCut').checked;
            const dealType = document.getElementById('dealType').value;

            // Calculate gross commission
            let grossCommission = propertyValue * (commissionRate / 100);

            // Adjust for rental deals (typically 10-12% of annual rent)
            if (dealType === 'rental') {
              grossCommission = grossCommission * 12; // Assuming input is monthly rent
            }

            // Calculate VAT
            let vatAmount;
            if (vatIncluded === 'included') {
              // VAT is already included in gross commission
              vatAmount = grossCommission - grossCommission / 1.15;
              grossCommission = grossCommission - vatAmount;
            } else {
              // Add VAT to gross commission
              vatAmount = grossCommission * 0.15;
            }

            // Calculate office split
            const officeSplitPercentage = 100 - agentSplit;
            const officeSplitAmount =
              grossCommission * (officeSplitPercentage / 100);

            // Calculate co-agent share
            const coAgentAmount = grossCommission * (coAgentSplit / 100);

            // Calculate referral fee
            const referralAmount = grossCommission * (referralFee / 100);

            // Calculate additional fees
            const ppaAmount = ppaProtection ? 1995 : 0;
            const marketingAmount = marketingContribution
              ? grossCommission * 0.01
              : 0;
            const teamLeaderAmount = teamLeaderCut ? grossCommission * 0.1 : 0;

            // Calculate net commission
            let netCommission = grossCommission * (agentSplit / 100);
            netCommission -= officeFees;
            netCommission -= coAgentAmount;
            netCommission -= referralAmount;
            netCommission -= ppaAmount;
            netCommission -= marketingAmount;
            netCommission -= teamLeaderAmount;

            // Ensure net commission doesn't go negative
            netCommission = Math.max(0, netCommission);

            // Calculate percentage of total
            const percentageOfTotal = (netCommission / grossCommission) * 100;

            // Display results
            document.getElementById('resultPropertyValue').textContent =
              formatCurrency(propertyValue);
            document.getElementById(
              'resultCommissionRate'
            ).textContent = `${commissionRate}%`;
            document.getElementById('resultGrossCommission').textContent =
              formatCurrency(
                grossCommission + (vatIncluded === 'included' ? 0 : vatAmount)
              );
            document.getElementById('resultVat').textContent =
              formatCurrency(vatAmount);
            document.getElementById('resultOfficeSplit').textContent =
              formatCurrency(officeSplitAmount);
            document.getElementById('resultOfficeFees').textContent =
              formatCurrency(officeFees);
            document.getElementById('resultCoAgent').textContent =
              formatCurrency(coAgentAmount);
            document.getElementById('resultReferralFee').textContent =
              formatCurrency(referralAmount);
            document.getElementById('resultNetCommission').textContent =
              formatCurrency(netCommission);
            document.getElementById(
              'resultPercentageOfTotal'
            ).textContent = `${percentageOfTotal.toFixed(1)}%`;

            // Show/hide additional fee results
            toggleResultElement(
              'resultPpaContainer',
              'resultPpa',
              ppaProtection,
              ppaAmount
            );
            toggleResultElement(
              'resultMarketingContainer',
              'resultMarketing',
              marketingContribution,
              marketingAmount
            );
            toggleResultElement(
              'resultTeamLeaderContainer',
              'resultTeamLeader',
              teamLeaderCut,
              teamLeaderAmount
            );

            // Show property image if available
            if (propertyImageUrl && propertyImageUrl.value) {
              propertyImage.src = propertyImageUrl.value;
              propertyImageContainer.style.display = 'block';
            } else {
              propertyImageContainer.style.display = 'none';
            }

            // Show property address if available
            if (propertyAddress && propertyAddress.value) {
              propertyAddressDisplay.textContent = propertyAddress.value;
              propertyAddressDisplay.style.display = 'block';
            } else {
              propertyAddressDisplay.style.display = 'none';
            }

            // Show results panel with animation
            resultsPanel.style.display = 'block';
            resultsPanel.classList.add('fade-in');

            // Reset button state
            calculateBtn.innerHTML =
              '<span class="material-icons">calculate</span> CALCULATE COMMISSION';
            calculateBtn.disabled = false;
          }, 500);
        }

        function toggleResultElement(
          containerId,
          elementId,
          isVisible,
          amount
        ) {
          const container = document.getElementById(containerId);
          const element = document.getElementById(elementId);

          if (isVisible) {
            container.style.display = 'flex';
            element.textContent = formatCurrency(amount);
          } else {
            container.style.display = 'none';
          }
        }

        function saveCalculation() {
          const propertyValue =
            parseFloat(document.getElementById('propertyValue').value) || 0;
          const netCommission =
            parseFloat(
              document
                .getElementById('resultNetCommission')
                .textContent.replace('R', '')
                .replace(/,/g, '')
            ) || 0;

          const calculation = {
            id: Date.now(),
            propertyValue: propertyValue,
            netCommission: netCommission,
            date: new Date().toLocaleDateString(),
          };

          savedCalculations.unshift(calculation);
          if (savedCalculations.length > 5) {
            savedCalculations.pop();
          }

          localStorage.setItem(
            'savedCalculations',
            JSON.stringify(savedCalculations)
          );
          updateRecentCalculations();

          // Save property data as well
          savePropertyData();

          // Show success feedback
          const originalText = saveResultBtn.innerHTML;
          saveResultBtn.innerHTML =
            '<span class="material-icons">check</span> Saved!';
          setTimeout(() => {
            saveResultBtn.innerHTML = originalText;
          }, 2000);
        }

        function updateRecentCalculations() {
          if (savedCalculations.length > 0) {
            recentCalculations.style.display = 'block';
            recentCalculationsBody.innerHTML = '';

            savedCalculations.forEach((calc) => {
              const row = document.createElement('tr');
              row.innerHTML = `
                            <td style="padding: 0.75rem; font-size: 0.875rem;">${formatCurrency(
                              calc.propertyValue
                            )}</td>
                            <td style="padding: 0.75rem; font-size: 0.875rem;">${formatCurrency(
                              calc.netCommission
                            )}</td>
                            <td style="padding: 0.75rem; font-size: 0.875rem;">${
                              calc.date
                            }</td>
                            <td style="padding: 0.75rem; font-size: 0.875rem;">
                                <button style="color: var(--primary); border: none; background: none; cursor: pointer;" onclick="loadCalculation(${
                                  calc.id
                                })">Load</button>
                                <button style="color: var(--error); border: none; background: none; cursor: pointer; margin-left: 0.5rem;" onclick="deleteCalculation(${
                                  calc.id
                                })">Delete</button>
                            </td>
                        `;
              recentCalculationsBody.appendChild(row);
            });
          } else {
            recentCalculations.style.display = 'none';
          }
        }

        // Format currency for display
        function formatCurrency(amount) {
          return 'R' + amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }

        // Show toast notification
        function showToast(message) {
          const toast = document.createElement('div');
          toast.className = 'toast';
          toast.textContent = message;
          document.body.appendChild(toast);

          setTimeout(() => {
            toast.style.transform = 'translateY(0)';
            toast.style.opacity = '1';
          }, 10);

          setTimeout(() => {
            toast.style.transform = 'translateY(20px)';
            toast.style.opacity = '0';
            setTimeout(() => {
              document.body.removeChild(toast);
            }, 300);
          }, 3000);
        }

        // Make functions available globally for the row buttons
        window.loadCalculation = function (id) {
          const calculation = savedCalculations.find((c) => c.id === id);
          if (calculation) {
            document.getElementById('propertyValue').value =
              calculation.propertyValue;
            calculateCommission();
            showToast('Calculation loaded');
          }
        };

        window.deleteCalculation = function (id) {
          savedCalculations = savedCalculations.filter((c) => c.id !== id);
          localStorage.setItem(
            'savedCalculations',
            JSON.stringify(savedCalculations)
          );
          updateRecentCalculations();
          showToast('Calculation deleted');
        };
      });
    </script>
  </body>
</html>
